name: Publish F-Droid Repo

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Override tag used for the APK filename when running manually'
        required: false
        default: ''
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./GooberEats
    env:
      FDROID_APP_ID: cloud.goober.goobereats
      BUILD_TOOLS_VERSION: '34.0.0'
      FDROID_REPO_PATH: ../fdroid-repo
    steps:
      - name: Checkout app source
        uses: actions/checkout@v6

      - name: Checkout F-Droid repo (gh-pages)
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          path: fdroid-repo

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: ${{ env.BUILD_TOOLS_VERSION }}

      - name: Install fdroidserver
        run: |
          pip install fdroidserver
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build unsigned release APK
        run: ./gradlew assembleRelease

      - name: Restore signing keystore
        run: |
          echo "$FDROID_KEYSTORE_B64" | base64 --decode > keystore.jks
        env:
          FDROID_KEYSTORE_B64: ${{ secrets.FDROID_KEYSTORE_B64 }}

      - name: Sign release APK
        run: |
          APK_UNSIGNED=app/build/outputs/apk/release/app-release-unsigned.apk
          APK_SIGNED=app/build/outputs/apk/release/app-release.apk
          cp "$APK_UNSIGNED" "$APK_SIGNED"
          apksigner sign \
            --ks keystore.jks \
            --ks-pass pass:"$KEYSTORE_PASSWORD" \
            --ks-key-alias "$KEY_ALIAS" \
            --key-pass pass:"$KEY_PASSWORD" \
            "$APK_SIGNED"
        env:
          KEYSTORE_PASSWORD: ${{ secrets.FDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.FDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.FDROID_KEY_PASSWORD }}

      - name: Copy APK into F-Droid repo
        run: |
          APK_SIGNED=app/build/outputs/apk/release/app-release.apk
          RELEASE_TAG="${GITHUB_REF_NAME:-}"
          if [[ -z "$RELEASE_TAG" ]]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          fi
          if [[ -z "$RELEASE_TAG" ]]; then
            RELEASE_TAG="manual-${GITHUB_RUN_NUMBER}"
          fi
          DEST_DIR="$FDROID_REPO_PATH/repo"
          mkdir -p "$DEST_DIR"
          cp "$APK_SIGNED" "$DEST_DIR/${FDROID_APP_ID}-${RELEASE_TAG}.apk"

      - name: Update F-Droid metadata and index
        working-directory: ${{ env.FDROID_REPO_PATH }}
        run: |
          mkdir -p metadata repo
          fdroid update --create-metadata --pretty
          fdroid update --use-date-from-apk --clean

      - name: Commit and push F-Droid repo
        working-directory: ${{ env.FDROID_REPO_PATH }}
        env:
          RELEASE_NAME: ${{ github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add --all
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            COMMIT_MSG=${RELEASE_NAME:-manual run $GITHUB_RUN_NUMBER}
            git commit -m "Update F-Droid repo for ${COMMIT_MSG}"
            git push origin HEAD:gh-pages
          fi

      - name: Clean up signing material
        if: always()
        run: rm -f keystore.jks
